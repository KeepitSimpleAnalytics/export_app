<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Air-gapped Data Utility</title>
    <style>
        body { font-family: sans-serif; margin: 2em; }
        .container { max-width: 800px; margin: 0 auto; }
        .form-group { margin-bottom: 1em; }
        label { display: block; margin-bottom: 0.5em; }
        input, select, textarea { width: 100%; padding: 0.5em; }
        button { padding: 0.7em 1.5em; }
        #response { margin-top: 1em; padding: 1em; border: 1px solid #ccc; background-color: #f9f9f9; }
        #discover-btn { background-color: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }
        #discover-btn:hover { background-color: #0056b3; }
        #discover-btn:disabled { background-color: #6c757d; cursor: not-allowed; }
        .table-item { 
            display: block; 
            padding: 0.5em; 
            margin: 0.2em 0; 
            background-color: #f8f9fa; 
            border: 1px solid #dee2e6; 
            border-radius: 4px; 
            cursor: pointer; 
            user-select: none;
        }
        .table-item:hover { background-color: #e9ecef; }
        .table-item.selected { background-color: #007bff; color: white; }
        .table-item-info { font-size: 0.8em; color: #666; margin-top: 0.2em; }
        .table-item.selected .table-item-info { color: #cce7ff; }
        .error { color: #dc3545; }
        .success { color: #28a745; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Air-gapped Data Utility (ADU)</h1>
        <p>Configure and start a new data migration job.</p>
        
        <form id="job-form">
            <div class="form-group">
                <label for="db_type">Database Type</label>
                <select id="db_type" name="db_type">
                    <option value="postgresql">PostgreSQL</option>
                    <option value="greenplum">Greenplum</option>
                    <option value="vertica">Vertica</option>
                </select>
            </div>
            <div class="form-group">
                <label for="db_host">Host</label>
                <input type="text" id="db_host" name="db_host" required>
            </div>
            <div class="form-group">
                <label for="db_port">Port</label>
                <input type="number" id="db_port" name="db_port" value="5432" required>
            </div>
            <div class="form-group">
                <label for="db_name">Database Name</label>
                <input type="text" id="db_name" name="db_name" required>
            </div>
            <div class="form-group">
                <label for="db_username">Username</label>
                <input type="text" id="db_username" name="db_username" required>
            </div>
            <div class="form-group">
                <label for="db_password">Password</label>
                <input type="password" id="db_password" name="db_password" required>
            </div>
            <div class="form-group">
                <button type="button" id="discover-btn" onclick="discoverSchema()">üîç Discover Database Schema</button>
                <div id="discovery-status" style="margin-top: 0.5em; font-size: 0.9em; color: #666;"></div>
            </div>
            
            <div class="form-group" id="schema-section" style="display: none;">
                <label for="schema-select">Schema Selection</label>
                <select id="schema-select" onchange="onSchemaChange()" style="margin-bottom: 0.5em;">
                    <option value="">Select a schema...</option>
                </select>
                <div id="schema-status" style="font-size: 0.9em; color: #666;"></div>
            </div>
            
            <div class="form-group" id="tables-section">
                <label for="tables">Tables to Export</label>
                <div style="margin-bottom: 0.5em;">
                    <label>
                        <input type="radio" name="table-mode" value="all" checked onchange="toggleTableMode()"> 
                        Export All Tables
                    </label>
                    <label style="margin-left: 1em;">
                        <input type="radio" name="table-mode" value="select" onchange="toggleTableMode()"> 
                        Select Specific Tables
                    </label>
                </div>
                
                <div id="tables-manual" style="display: none;">
                    <textarea id="tables" name="tables" rows="3" placeholder="e.g., users,orders,products"></textarea>
                    <small>Enter table names separated by commas</small>
                </div>
                
                <div id="tables-discovered" style="display: none;">
                    <div id="table-list" style="max-height: 200px; overflow-y: auto; border: 1px solid #ddd; padding: 0.5em;">
                        <!-- Discovered tables will be populated here -->
                    </div>
                    <small>Select tables to export (click to toggle selection)</small>
                </div>
            </div>
            
            <div class="form-group">
                <label for="output_path">Output Path (default: /app/exports)</label>
                <input type="text" id="output_path" name="output_path" value="/app/exports" placeholder="/app/exports">
                <small>Each table will be exported to its own subdirectory within the job folder</small>
            </div>
            
            <div class="form-group">
                <label for="chunk_size">Chunk Size for Large Tables</label>
                <select id="chunk_size" name="chunk_size">
                    <option value="100000">100,000 rows per file</option>
                    <option value="500000">500,000 rows per file</option>
                    <option value="1000000" selected>1,000,000 rows per file (recommended)</option>
                    <option value="2000000">2,000,000 rows per file</option>
                    <option value="5000000">5,000,000 rows per file</option>
                    <option value="10000000">10,000,000 rows per file</option>
                </select>
                <small>Large tables will be automatically partitioned into multiple Parquet files of this size</small>
            </div>
            
            <div class="form-group">
                <label for="max_threads">Parallel Processing Threads</label>
                <select id="max_threads" name="max_threads">
                    <option value="1">1 thread (sequential)</option>
                    <option value="2">2 threads</option>
                    <option value="4">4 threads</option>
                    <option value="6">6 threads</option>
                    <option value="8">8 threads (recommended for 16 vCPU)</option>
                    <option value="12" selected>12 threads (optimal for 16 vCPU + 128GB)</option>
                    <option value="16">16 threads (maximum)</option>
                </select>
                <small>Number of tables to process simultaneously. With 16 vCPUs, 12 threads is optimal</small>
            </div>
            
            <div class="form-group">
                <label for="max_chunk_workers">Chunk Processing Threads (for Large Tables)</label>
                <select id="max_chunk_workers" name="max_chunk_workers">
                    <option value="4">4 chunk threads</option>
                    <option value="6">6 chunk threads</option>
                    <option value="8" selected>8 chunk threads (optimal for 16 vCPU + 128GB)</option>
                    <option value="10">10 chunk threads</option>
                    <option value="12">12 chunk threads (aggressive)</option>
                    <option value="16">16 chunk threads (maximum)</option>
                </select>
                <small>For tables with 10M+ rows, process chunks in parallel. 8 threads optimal for your 16 vCPU system</small>
            </div>
            
            <div class="form-group" style="background-color: #f0f8ff; padding: 1em; border-radius: 4px; border: 1px solid #b3d9ff;">
                <h4 style="margin-top: 0; color: #0056b3;">ÔøΩÔ∏è Export Organization (NEW!)</h4>
                
                <div style="margin-bottom: 1em;">
                    <label for="export_strategy">Directory Organization</label>
                    <select id="export_strategy" name="export_strategy">
                        <option value="clean_with_archive" selected>Clean Structure + Archive (Recommended)</option>
                        <option value="direct">Direct Export (Simple)</option>
                        <option value="schema_first">Schema-Based Organization</option>
                    </select>
                </div>
                
                <div style="margin-bottom: 1em;">
                    <label for="conflict_resolution">Handle Conflicts</label>
                    <select id="conflict_resolution" name="conflict_resolution">
                        <option value="version" selected>Version (table_v2, table_v3)</option>
                        <option value="timestamp">Timestamp (table_2025-08-05_14-30)</option>
                        <option value="overwrite">Overwrite Previous</option>
                    </select>
                </div>
                
                <div style="font-size: 0.9em; color: #0056b3;">
                    <strong>üìÅ Final Structure (Clean):</strong>
                    <pre style="background-color: #e6f3ff; padding: 0.5em; font-size: 0.8em; margin: 0.5em 0; border-radius: 3px;">exports/
‚îú‚îÄ‚îÄ public_employees/          ‚Üê Direct table access
‚îÇ   ‚îú‚îÄ‚îÄ part_0001.parquet
‚îÇ   ‚îî‚îÄ‚îÄ _export_metadata.json
‚îú‚îÄ‚îÄ analytics_sales_data/
‚îî‚îÄ‚îÄ .archive/jobs/             ‚Üê Job history preserved
    ‚îî‚îÄ‚îÄ job_12345_timestamp.json</pre>
                    <span style="color: #28a745;">‚úÖ No job ID clutter in final structure!</span><br>
                    <span style="color: #28a745;">‚úÖ Easy table access: <code>exports/table_name/</code></span><br>
                    <span style="color: #28a745;">‚úÖ Complete job history preserved</span>
                </div>
            </div>
            
            <button type="submit">Start Export Job</button>
        </form>

        <div id="response" style="display:none;"></div>

        <hr style="margin: 2em 0;">
        <a href="/history">View All Job History</a> | 
        <a href="/chunks">Chunk Processing Monitor</a> | 
        <a href="/logs">Worker Logs</a>
    </div>

    <script>
        let discoveredTables = [];
        let selectedTables = [];
        let discoveredSchemas = [];
        let tablesBySchema = {};

        function toggleTableMode() {
            const mode = document.querySelector('input[name="table-mode"]:checked').value;
            const manualDiv = document.getElementById('tables-manual');
            const discoveredDiv = document.getElementById('tables-discovered');
            
            if (mode === 'select') {
                if (discoveredTables.length > 0) {
                    discoveredDiv.style.display = 'block';
                    manualDiv.style.display = 'none';
                } else {
                    manualDiv.style.display = 'block';
                    discoveredDiv.style.display = 'none';
                }
            } else {
                manualDiv.style.display = 'none';
                discoveredDiv.style.display = 'none';
            }
        }

        function discoverSchema() {
            const btn = document.getElementById('discover-btn');
            const status = document.getElementById('discovery-status');
            
            // Get connection details
            const formData = new FormData(document.getElementById('job-form'));
            const data = Object.fromEntries(formData.entries());
            
            // Validate required fields
            const required = ['db_type', 'db_host', 'db_port', 'db_username', 'db_password'];
            const missing = required.filter(field => !data[field]);
            
            if (missing.length > 0) {
                status.innerHTML = `<span class="error">Please fill in: ${missing.join(', ')}</span>`;
                return;
            }
            
            btn.disabled = true;
            btn.textContent = 'üîÑ Discovering...';
            status.innerHTML = '<span style="color: #007bff;">Connecting to database...</span>';
            
            // First discover schemas
            fetch('/api/discover-schemas', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data),
            })
            .then(response => response.json())
            .then(result => {
                if (result.error) {
                    status.innerHTML = `<span class="error">Error: ${result.error}</span>`;
                } else {
                    discoveredSchemas = result.schemas;
                    status.innerHTML = `<span class="success">Found ${result.count} schemas in ${result.database_type} database</span>`;
                    
                    // Populate schema dropdown
                    populateSchemaDropdown(result.schemas);
                    
                    // Show schema section
                    document.getElementById('schema-section').style.display = 'block';
                    
                    // Discover all tables by schema for better organization
                    discoverAllTables(data);
                }
            })
            .catch(error => {
                status.innerHTML = `<span class="error">Connection failed: ${error.message}</span>`;
                console.error('Error:', error);
            })
            .finally(() => {
                btn.disabled = false;
                btn.textContent = 'üîç Discover Database Schema';
            });
        }

        function populateTableList(tables) {
            const tableList = document.getElementById('table-list');
            tableList.innerHTML = '';
            selectedTables = [];
            
            if (tables.length === 0) {
                tableList.innerHTML = '<p>No tables found</p>';
                return;
            }
            
            tables.forEach(tableName => {
                const tableItem = document.createElement('div');
                tableItem.className = 'table-item';
                tableItem.onclick = () => toggleTableSelection(tableName, tableItem);
                
                // Get chunk size for preview calculation
                const chunkSize = parseInt(document.getElementById('chunk_size').value) || 1000000;
                
                tableItem.innerHTML = `
                    <div><strong>${tableName}</strong></div>
                    <div class="table-item-info">
                        <span class="table-preview-info" data-table="${tableName}">Click to preview partitioning info...</span>
                    </div>
                `;
                
                tableList.appendChild(tableItem);
                
                // Load table preview asynchronously
                loadTablePreview(tableName, tableItem, chunkSize);
            });
        }
        
        function loadTablePreview(tableName, tableItem, chunkSize) {
            // Get connection details for preview
            const connectionData = {
                db_type: document.getElementById('db_type').value,
                db_host: document.getElementById('db_host').value,
                db_port: document.getElementById('db_port').value,
                db_username: document.getElementById('db_username').value,
                db_password: document.getElementById('db_password').value,
                db_name: document.getElementById('db_name').value,
                table_name: tableName,
                chunk_size: chunkSize
            };
            
            // Only load if we have connection details
            if (!connectionData.db_host || !connectionData.db_username || !connectionData.db_password) {
                return;
            }
            
            fetch('/api/table-info', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(connectionData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    const infoSpan = tableItem.querySelector('.table-preview-info');
                    infoSpan.textContent = 'Error loading info';
                    return;
                }
                
                const partInfo = data.partitioning_info;
                const infoSpan = tableItem.querySelector('.table-preview-info');
                
                let infoText = `${data.row_count.toLocaleString()} rows, ${data.column_count} columns`;
                
                if (partInfo.will_be_partitioned) {
                    infoText += ` ‚Üí ${partInfo.estimated_chunks} files (~${partInfo.estimated_size_mb} MB)`;
                } else {
                    infoText += ` ‚Üí 1 file (~${partInfo.estimated_size_mb} MB)`;
                }
                
                infoSpan.textContent = infoText;
            })
            .catch(error => {
                const infoSpan = tableItem.querySelector('.table-preview-info');
                infoSpan.textContent = 'Preview unavailable';
            });
        }

        function toggleTableSelection(tableName, element) {
            if (selectedTables.includes(tableName)) {
                selectedTables = selectedTables.filter(t => t !== tableName);
                element.classList.remove('selected');
            } else {
                selectedTables.push(tableName);
                element.classList.add('selected');
            }
            
            // Update the hidden tables input
            document.getElementById('tables').value = selectedTables.join(',');
        }

        function populateSchemaDropdown(schemas) {
            const schemaSelect = document.getElementById('schema-select');
            schemaSelect.innerHTML = '<option value="">Select a schema...</option>';
            
            schemas.forEach(schema => {
                const option = document.createElement('option');
                option.value = schema;
                option.textContent = schema;
                schemaSelect.appendChild(option);
            });
            
            // Add "All schemas" option
            const allOption = document.createElement('option');
            allOption.value = '_ALL_';
            allOption.textContent = 'üåê All Schemas';
            schemaSelect.appendChild(allOption);
        }

        function discoverAllTables(connectionData) {
            fetch('/api/discover-tables-by-schema', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(connectionData),
            })
            .then(response => response.json())
            .then(result => {
                if (result.error) {
                    document.getElementById('discovery-status').innerHTML = `<span class="error">Error loading tables: ${result.error}</span>`;
                } else {
                    tablesBySchema = result.tables_by_schema;
                    discoveredTables = result.tables.map(t => t.full_name);
                    
                    document.getElementById('discovery-status').innerHTML = 
                        `<span class="success">Found ${result.total_tables} tables across ${result.schema_count} schemas</span>`;
                }
            })
            .catch(error => {
                console.error('Error loading tables:', error);
            });
        }

        function onSchemaChange() {
            const schemaSelect = document.getElementById('schema-select');
            const selectedSchema = schemaSelect.value;
            const schemaStatus = document.getElementById('schema-status');
            
            if (!selectedSchema) {
                schemaStatus.innerHTML = '';
                document.getElementById('table-list').innerHTML = '';
                return;
            }
            
            if (selectedSchema === '_ALL_') {
                // Show all tables from all schemas
                const allTables = [];
                Object.keys(tablesBySchema).forEach(schema => {
                    tablesBySchema[schema].forEach(table => {
                        allTables.push(table.full_name);
                    });
                });
                populateTableList(allTables);
                schemaStatus.innerHTML = `Showing all ${allTables.length} tables from all schemas`;
            } else {
                // Show tables from selected schema
                const schemaTables = tablesBySchema[selectedSchema] || [];
                const tableNames = schemaTables.map(t => t.full_name);
                populateTableList(tableNames);
                schemaStatus.innerHTML = `Showing ${schemaTables.length} tables from schema "${selectedSchema}"`;
            }
            
            // Switch to select mode and show discovered tables
            document.querySelector('input[name="table-mode"][value="select"]').checked = true;
            toggleTableMode();
        }

        function getSelectedTables() {
            const mode = document.querySelector('input[name="table-mode"]:checked').value;
            
            if (mode === 'all') {
                return [];  // Empty array means all tables
            } else if (mode === 'select') {
                if (discoveredTables.length > 0) {
                    return selectedTables;
                } else {
                    // Manual entry
                    const tablesInput = document.getElementById('tables').value;
                    return tablesInput ? tablesInput.split(',').map(t => t.trim()).filter(t => t) : [];
                }
            }
        }

        document.getElementById('job-form').addEventListener('submit', function(event) {
            event.preventDefault();
            
            const formData = new FormData(event.target);
            const data = Object.fromEntries(formData.entries());
            const responseDiv = document.getElementById('response');

            // Get selected tables based on mode
            data.tables = getSelectedTables();
            
            // Convert chunk_size to integer
            data.chunk_size = parseInt(data.chunk_size);
            
            // Convert max_threads to integer
            data.max_threads = parseInt(data.max_threads);
            
            // Convert max_chunk_workers to integer
            data.max_chunk_workers = parseInt(data.max_chunk_workers);
            
            // Add export organization configuration
            data.export_organization = {
                strategy: data.export_strategy || 'clean_with_archive',
                conflict_resolution: data.conflict_resolution || 'version',
                preserve_job_history: true,
                auto_cleanup_temp: true
            };
            
            // Remove the individual fields since they're now in the object
            delete data.export_strategy;
            delete data.conflict_resolution;
            
            // Validate chunk size
            if (data.chunk_size < 10000 || data.chunk_size > 10000000) {
                responseDiv.style.display = 'block';
                responseDiv.innerHTML = `<span class="error">Error: Chunk size must be between 10,000 and 10,000,000 rows</span>`;
                return;
            }
            
            // Validate max_threads
            if (data.max_threads < 1 || data.max_threads > 16) {
                responseDiv.style.display = 'block';
                responseDiv.innerHTML = `<span class="error">Error: Thread count must be between 1 and 16</span>`;
                return;
            }
            
            // Validate max_chunk_workers
            if (data.max_chunk_workers < 1 || data.max_chunk_workers > 16) {
                responseDiv.style.display = 'block';
                responseDiv.innerHTML = `<span class="error">Error: Chunk worker count must be between 1 and 16</span>`;
                return;
            }

            fetch('/api/jobs', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data),
            })
            .then(response => response.json())
            .then(result => {
                responseDiv.style.display = 'block';
                if (result.job_id) {
                    responseDiv.innerHTML = `<span class="success">Successfully started job. ID: ${result.job_id}</span>`;
                    responseDiv.innerHTML += `<br><a href="/job/${result.job_id}">View job details</a>`;
                    responseDiv.innerHTML += `<br><small>Using chunk size: ${data.chunk_size.toLocaleString()} rows per file</small>`;
                    responseDiv.innerHTML += `<br><small>Processing with ${data.max_threads} table thread(s) and ${data.max_chunk_workers} chunk worker(s)</small>`;
                } else if (result.error) {
                    responseDiv.innerHTML = `<span class="error">Error: ${result.error}</span>`;
                } else {
                    responseDiv.innerHTML = `<span class="error">Unknown error occurred</span>`;
                }
            })
            .catch(error => {
                responseDiv.style.display = 'block';
                responseDiv.innerHTML = `<span class="error">An error occurred: ${error.message}</span>`;
                console.error('Error:', error);
            });
        });

        // Initialize table mode
        toggleTableMode();
    </script>
</body>
</html>