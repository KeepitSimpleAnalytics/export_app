<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Worker Logs</title>
    <style>
        body { font-family: sans-serif; margin: 2em; }
        .container { max-width: 95vw; margin: 0 auto; }
        .nav-link { display: inline-block; margin: 1em 0; color: #007bff; text-decoration: none; }
        .nav-link:hover { text-decoration: underline; }
        .controls { margin: 1em 0; display: flex; gap: 1em; align-items: center; flex-wrap: wrap; }
        .controls input, .controls select, .controls button { padding: 0.5em; }
        .log-container { 
            background-color: #f8f9fa; 
            border: 1px solid #dee2e6; 
            border-radius: 4px; 
            padding: 1em; 
            max-height: 80vh; 
            min-height: 600px;
            overflow-y: auto; 
            font-family: 'Courier New', monospace; 
            font-size: 0.85em; 
            white-space: pre-wrap; 
            line-height: 1.3;
        }
        .log-info { margin: 1em 0; color: #666; font-size: 0.9em; }
        .error { color: #dc3545; }
        .warning { color: #fd7e14; }
        .info { color: #28a745; }
        .refresh-btn { background-color: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }
        .refresh-btn:hover { background-color: #0056b3; }
        .auto-refresh { margin-left: 1em; }
        .log-line { margin: 0.2em 0; }
        .highlight { background-color: #fff3cd; }
    </style>
</head>
<body>
    <div class="container">
        <a href="/history" class="nav-link">‚Üê Back to Job History</a>
        
        <h1>Worker Logs</h1>
        
        <div class="controls">
            <label>
                Job ID Filter:
                <input type="text" id="job-filter" placeholder="Enter job ID to filter">
            </label>
            
            <label>
                Content Filter:
                <select id="content-filter">
                    <option value="">All Logs</option>
                    <option value="chunk">Chunk Processing</option>
                    <option value="processing">Data Processing</option>
                    <option value="export">Export Operations</option>
                    <option value="error">Errors Only</option>
                    <option value="polars">Polars Operations</option>
                </select>
            </label>
            
            <label>
                Lines to show:
                <select id="lines-select">
                    <option value="50">50</option>
                    <option value="100" selected>100</option>
                    <option value="200">200</option>
                    <option value="500">500</option>
                    <option value="1000">1000</option>
                </select>
            </label>
            
            <button class="refresh-btn" onclick="loadLogs()">Refresh</button>
            
            <button class="refresh-btn" onclick="testApiConnectivity()" style="background-color: #28a745;">Test API</button>
            
            <label class="auto-refresh">
                <input type="checkbox" id="auto-refresh" checked>
                Auto-refresh (10s)
            </label>
        </div>
        
        <div class="log-info" id="log-info">
            <!-- Log information will be populated here -->
        </div>
        
        <div class="log-container" id="log-container">
            <!-- Log content will be populated here -->
        </div>
    </div>

    <script>
        let refreshInterval;
        
        function testApiConnectivity() {
            const logInfo = document.getElementById('log-info');
            const logContainer = document.getElementById('log-container');
            
            logInfo.innerHTML = '<span style="color: #007bff;">üîÑ Testing API connectivity...</span>';
            
            fetch('/api/logs/test')
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    return response.json();
                })
                .then(data => {
                    logInfo.innerHTML = `
                        <span class="info">‚úÖ API Connection Successful!</span><br>
                        Server Time: ${data.server_time}<br>
                        Log File Exists: ${data.log_file_exists ? '‚úÖ' : '‚ùå'}<br>
                        Log File Readable: ${data.log_file_readable ? '‚úÖ' : '‚ùå'}<br>
                        Path: ${data.log_file_path}
                    `;
                    
                    if (data.log_file_exists && data.log_file_readable) {
                        setTimeout(() => loadLogs(), 1000);
                    } else {
                        logContainer.textContent = data.log_file_exists ? 
                            'Log file exists but is not readable.' : 
                            'Log file does not exist yet. Start a worker process to create logs.';
                    }
                })
                .catch(error => {
                    logInfo.innerHTML = `<span class="error">‚ùå API Connection Failed: ${error.message}</span>`;
                    logContainer.textContent = `Connectivity test failed: ${error.message}`;
                });
        }
        
        function loadLogs() {
            const jobFilter = document.getElementById('job-filter').value.trim();
            const contentFilter = document.getElementById('content-filter').value;
            const lines = document.getElementById('lines-select').value;
            const logContainer = document.getElementById('log-container');
            const logInfo = document.getElementById('log-info');
            
            // Build query parameters
            const params = new URLSearchParams({ lines });
            if (jobFilter) {
                params.append('job_id', jobFilter);
            }
            
            fetch(`/api/logs/worker?${params}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.error) {
                        logContainer.textContent = `Error: ${data.error}`;
                        logInfo.textContent = '';
                        return;
                    }
                    
                    // Handle different status conditions
                    if (data.status && data.status !== 'success') {
                        let statusMessage = '';
                        switch (data.status) {
                            case 'log_file_not_found':
                                statusMessage = '‚ÑπÔ∏è Worker hasn\'t started yet - log file will appear once worker processes begin.';
                                break;
                            case 'empty_log':
                                statusMessage = '‚ÑπÔ∏è Worker log is empty - no activity logged yet.';
                                break;
                            case 'permission_error':
                                statusMessage = '‚ö†Ô∏è Cannot access log file due to permissions.';
                                break;
                            default:
                                statusMessage = `Status: ${data.status}`;
                        }
                        logInfo.innerHTML = statusMessage;
                    }
                    
                    // Apply content filtering
                    let filteredLines = data.lines;
                    if (contentFilter) {
                        const filterPatterns = {
                            'chunk': /chunk|partition|split|part_\d+|chunks_|processing chunk/i,
                            'processing': /processing|export|write|read|starting|completed|finished/i,
                            'export': /export|parquet|file|save|table.*rows|successfully exported/i,
                            'error': /error|exception|failed|traceback|critical|warning/i,
                            'polars': /polars|dataframe|lazy|read_database|write_parquet/i
                        };
                        
                        const pattern = filterPatterns[contentFilter];
                        if (pattern) {
                            filteredLines = data.lines.filter(line => pattern.test(line));
                        }
                    }
                    
                    // Update log info
                    const totalShowing = filteredLines.length;
                    logInfo.innerHTML = `
                        Showing ${totalShowing} of ${data.showing} lines (${data.total_lines} total)
                        ${data.filtered ? `(job filtered: ${jobFilter})` : ''}
                        ${contentFilter ? `(content filtered: ${contentFilter})` : ''}
                        - Last updated: ${new Date().toLocaleTimeString()}
                    `;
                    
                    // Process and display log lines
                    logContainer.innerHTML = '';
                    filteredLines.forEach(line => {
                        const logLine = document.createElement('div');
                        logLine.className = 'log-line';
                        
                        // Add highlighting for different log levels
                        if (/ERROR|CRITICAL|Failed|Exception/i.test(line)) {
                            logLine.classList.add('error');
                        } else if (/WARNING|Warning/i.test(line)) {
                            logLine.classList.add('warning');
                        } else if (/SUCCESS|completed|successfully|finished/i.test(line)) {
                            logLine.classList.add('info');
                        }
                        
                        // Highlight filtered content
                        if (jobFilter && line.includes(jobFilter)) {
                            logLine.classList.add('highlight');
                        }
                        if (contentFilter && contentFilter !== 'error') {
                            const filterPatterns = {
                                'chunk': /chunk|partition|split/gi,
                                'processing': /processing|export|write|read/gi,
                                'export': /export|parquet|file|save/gi,
                                'polars': /polars|dataframe|lazy/gi
                            };
                            
                            const pattern = filterPatterns[contentFilter];
                            if (pattern) {
                                line = line.replace(pattern, match => `<mark>${match}</mark>`);
                            }
                        }
                        
                        logLine.innerHTML = line;
                        logContainer.appendChild(logLine);
                    });
                    
                    // Auto-scroll to bottom
                    logContainer.scrollTop = logContainer.scrollHeight;
                })
                .catch(error => {
                    console.error('Log fetch error:', error);
                    
                    let errorMessage = 'Error loading logs: ';
                    if (error.message.includes('Failed to fetch')) {
                        errorMessage += 'Network connection failed. Please check:\n';
                        errorMessage += '‚Ä¢ Is the application server running?\n';
                        errorMessage += '‚Ä¢ Are you accessing the correct port/URL?\n';
                        errorMessage += '‚Ä¢ Check browser console for more details.';
                    } else if (error.message.includes('HTTP 404')) {
                        errorMessage += 'API endpoint not found (HTTP 404)\n';
                        errorMessage += 'The logs API may not be available.';
                    } else if (error.message.includes('HTTP 500')) {
                        errorMessage += 'Server error (HTTP 500)\n';
                        errorMessage += 'Check server logs for more details.';
                    } else {
                        errorMessage += error.message;
                    }
                    
                    logContainer.textContent = errorMessage;
                    logInfo.innerHTML = '<span class="error">‚ö†Ô∏è Failed to connect to logs API</span>';
                });
        }
        
        function startAutoRefresh() {
            const autoRefreshCheckbox = document.getElementById('auto-refresh');
            
            if (autoRefreshCheckbox.checked) {
                refreshInterval = setInterval(loadLogs, 10000); // 10 seconds
            } else if (refreshInterval) {
                clearInterval(refreshInterval);
                refreshInterval = null;
            }
        }
        
        // Event listeners
        document.getElementById('job-filter').addEventListener('input', loadLogs);
        document.getElementById('content-filter').addEventListener('change', loadLogs);
        document.getElementById('lines-select').addEventListener('change', loadLogs);
        document.getElementById('auto-refresh').addEventListener('change', startAutoRefresh);
        
        // Check for job_id parameter in URL
        const urlParams = new URLSearchParams(window.location.search);
        const jobIdParam = urlParams.get('job_id');
        if (jobIdParam) {
            document.getElementById('job-filter').value = jobIdParam;
        }

        // Initial load
        loadLogs();
        startAutoRefresh();
        
        // Clean up interval when page is unloaded
        window.addEventListener('beforeunload', () => {
            if (refreshInterval) {
                clearInterval(refreshInterval);
            }
        });
    </script>
</body>
</html>